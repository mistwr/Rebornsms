<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8" />
<title>Envio Massivo de SMS com Excel/CSV</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 700px; margin: 20px auto; }
  label { display: block; margin-top: 15px; }
  input, textarea, button { width: 100%; padding: 8px; margin-top: 5px; }
  #contactsList { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; margin-top: 10px; padding: 5px; }
  #contactsList div { padding: 3px; border-bottom: 1px solid #eee; }
  #status { margin-top: 20px; white-space: pre-wrap; height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
</style>
</head>
<body>

<h1>Envio Massivo de SMS via Gateway</h1>

<label for="gatewayUrl">URL do Gateway (ex: http://192.168.1.242:8080/send-G-sms)</label>
<input type="text" id="gatewayUrl" placeholder="Coloque o URL completo do endpoint" required />

<label for="fileInput">Importar contactos CSV ou Excel (.xlsx)</label>
<input type="file" id="fileInput" accept=".csv, .xlsx, .xls" />

<label for="message">Mensagem a enviar (use {nome} para personalizar)</label>
<textarea id="message" rows="4" placeholder="Ex: Olá {nome}, esta é uma mensagem personalizada!" required></textarea>

<button id="sendAllBtn">Enviar SMS para Todos</button>

<h2>Lista de Contactos</h2>
<div id="contactsList">Nenhum contacto importado.</div>

<h2>Status do Envio</h2>
<div id="status"></div>

<!-- Biblioteca SheetJS para ler Excel -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/shim.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<script>
const fileInput = document.getElementById('fileInput');
const contactsListDiv = document.getElementById('contactsList');
const statusDiv = document.getElementById('status');
const sendButton = document.getElementById('sendAllBtn');
let contacts = [];

function isExcelFile(filename) {
  return filename.endsWith('.xlsx') || filename.endsWith('.xls');
}

function isCSVFile(filename) {
  return filename.endsWith('.csv');
}

function parseCSV(text) {
  const lines = text.trim().split('\n');
  const contacts = [];
  for(let line of lines) {
    const parts = line.split(',');
    if(parts[0]) {
      contacts.push({ phone: parts[0].trim(), name: parts[1] ? parts[1].trim() : '' });
    }
  }
  return contacts;
}

function parseExcel(data) {
  const workbook = XLSX.read(data, {type: 'binary'});
  const firstSheetName = workbook.SheetNames[0];
  const worksheet = workbook.Sheets[firstSheetName];
  const sheetData = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval:""});

  const headers = sheetData[0].map(h => h.toString().toLowerCase());

  const phoneIdx = headers.findIndex(h => ['telefone', 'phone', 'número', 'numero', 'celular'].includes(h));
  const nameIdx = headers.findIndex(h => ['nome', 'name'].includes(h));

  if(phoneIdx === -1) {
    alert('Coluna de telefone não encontrada no Excel. Certifique-se que tem uma coluna chamada "telefone", "phone", "número", etc.');
    return [];
  }

  const contacts = [];
  for(let i=1; i < sheetData.length; i++) {
    const row = sheetData[i];
    if(!row) continue;
    const phone = row[phoneIdx] ? row[phoneIdx].toString().trim() : '';
    const name = (nameIdx !== -1 && row[nameIdx]) ? row[nameIdx].toString().trim() : '';
    if(phone) {
      contacts.push({ phone, name });
    }
  }
  return contacts;
}

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();

  reader.onload = function(event) {
    const data = event.target.result;
    if (isCSVFile(file.name.toLowerCase())) {
      contacts = parseCSV(data);
      if (contacts.length === 0) alert('Nenhum contacto encontrado no CSV.');
      displayContacts();
      console.log('Contacts from CSV:', contacts);
    } else if (isExcelFile(file.name.toLowerCase())) {
      try {
        const contactsExcel = parseExcel(data);
        contacts = contactsExcel;
        if (contacts.length === 0) alert('Nenhum contacto encontrado no Excel. Confirme as colunas.');
        displayContacts();
        console.log('Contacts from Excel:', contacts);
      } catch (err) {
        alert('Erro ao ler ficheiro Excel: ' + err.message);
        console.error(err);
      }
    } else {
      alert('Formato de ficheiro não suportado.');
    }
  };

  if (isCSVFile(file.name.toLowerCase())) {
    reader.readAsText(file);
  } else if (isExcelFile(file.name.toLowerCase())) {
    reader.readAsBinaryString(file);
  } else {
    alert('Formato de ficheiro não suportado.');
  }
});

function displayContacts() {
  if(contacts.length === 0) {
    contactsListDiv.textContent = 'Nenhum contacto encontrado no ficheiro.';
  } else {
    contactsListDiv.innerHTML = '';
    contacts.forEach(c => {
      contactsListDiv.innerHTML += `<div>${c.name ? c.name + ' - ' : ''}${c.phone}</div>`;
    });
  }
}

sendButton.addEventListener('click', async () => {
  const url = document.getElementById('gatewayUrl').value.trim();
  const messageTemplate = document.getElementById('message').value.trim();

  if(!url) {
    alert('Coloque a URL do Gateway!');
    return;
  }
  if(!messageTemplate) {
    alert('Digite a mensagem a enviar!');
    return;
  }
  if(contacts.length === 0) {
    alert('Importe a lista de contactos antes de enviar!');
    return;
  }

  sendButton.disabled = true;
  statusDiv.textContent = `Começando envio para ${contacts.length} contactos...\n`;
  let sentCount = 0;

  async function sendSms(contact) {
    let personalizedMessage = messageTemplate.replace(/{nome}/gi, contact.name || contact.phone);

    try {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ phone: contact.phone, message: personalizedMessage })
      });
      if(res.ok) {
        sentCount++;
        statusDiv.textContent += `✔️ SMS enviado para ${contact.phone} (${contact.name || 'Sem nome'})\n`;
        statusDiv.textContent += `Progresso: ${sentCount} / ${contacts.length}\n\n`;
        statusDiv.scrollTop = statusDiv.scrollHeight;
        return true;
      } else {
        statusDiv.textContent += `❌ Erro ${res.status} ao enviar para ${contact.phone}\n`;
        statusDiv.scrollTop = statusDiv.scrollHeight;
        return false;
      }
    } catch(err) {
      statusDiv.textContent += `❌ Erro ao enviar para ${contact.phone}: ${err.message}\n`;
      statusDiv.scrollTop = statusDiv.scrollHeight;
      return false;
    }
  }

  for(const contact of contacts) {
    await sendSms(contact);
  }

  statusDiv.textContent += `\nEnvio concluído! Foram enviados ${sentCount} de ${contacts.length} SMS.`;
  sendButton.disabled = false;
});
</script>

</body>
</html>
